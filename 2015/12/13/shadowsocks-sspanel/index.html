<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 搭建自己的shadowsocks分享服务器 · luobbe的随笔</title><meta name="description" content="搭建自己的shadowsocks分享服务器 - luobbe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.luobbe.com/atom.xml" title="luobbe的随笔"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">搭建自己的shadowsocks分享服务器</h1><div class="post-info">2015年12月13日</div><div class="post-content"><blockquote>
<p>本文针对 ss-panel V2 版本的教程</p>
</blockquote>
<p>周末本想出去转转，无奈帝都的雾霾太大，只能在家里撸码，整了一个ss账号分享平台，在这记录一下过程吧。</p>
<p>本文是基于Ubuntu 14.04下使用后端manyuser和前端ss-panel，使用nginx做代理所搭建的。<br>服务器推荐<a href="https://www.vultr.com/?ref=6928081" target="_blank" rel="noopener">vultr</a>、<a href="https://m.do.co/c/fe08bbc0a6c0" target="_blank" rel="noopener">digitalocean</a>。</p>
<h6 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h6><p>首先我们远程登录服务器，安装nginx,mysql和php,具体命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get update</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install nginx</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install mysql-client-5.5 mysql-server-5.5</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install php5 php5-fpm php5-cli php5-cgi php5-mysql php5-gd</span><br></pre></td></tr></table></figure></p>
<p>过程中如果没有错误，那就说明我们安装成功了，如果服务器中有这些环境，则可以忽略对应的步骤。</p>
<p>接下来我们就要创建数据库了，运行<code>mysql -u root -p</code>，输入<code>root</code>密码。开始创建<code>shadowsocks</code>数据库，具体<code>SQL:create database shadowsocks;</code>,如下图：</p>
<p><img src="http://ww4.sinaimg.cn/large/9f1201f5gw1eyydknilqkj20vq0c2wkj.jpg" alt=""></p>
<p>然后建立一个名为ss，密码为ss的MySQL用户，因为这个用户只能本地登录，所以密码简单点也无所谓：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  grant all privileges on shadowsocks.* to ss@localhost identified by &apos;ss&apos;;</span><br></pre></td></tr></table></figure></p>
<p>创建完成我们退出MySQL:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  exit；</span><br></pre></td></tr></table></figure></p>
<p>到这步，我们的数据库已经完成了。<a id="more"></a>下面我们来安装shadowsocks ss-panel supervisor，一次执行下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install python-pip git python-m2crypto</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# pip install cymysql</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# git clone -b manyuser https://github.com/mengskysama/shadowsocks.git</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# cd shadowsocks/shadowsocks/</span><br></pre></td></tr></table></figure></p>
<p>如果是服务器上没有git，则需要先安装git，具体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# pip install git</span><br></pre></td></tr></table></figure></p>
<p>然后我们来修改配置文件/root/shadowsocks/shadowsocks/Config.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#Config</span><br><span class="line">MYSQL_HOST = &apos;localhost&apos;</span><br><span class="line">MYSQL_PORT = 3306</span><br><span class="line">MYSQL_USER = &apos;ss&apos;</span><br><span class="line">MYSQL_PASS = &apos;ss&apos;</span><br><span class="line">MYSQL_DB = &apos;shadowsocks&apos;</span><br><span class="line">MANAGE_PASS = &apos;ss233333333&apos;</span><br><span class="line">#if you want manage in other server you should set this value to global ip</span><br><span class="line">MANAGE_BIND_IP = &apos;127.0.0.1&apos;</span><br><span class="line">#make sure this port is idle</span><br><span class="line">MANAGE_PORT = 23333</span><br></pre></td></tr></table></figure>
<p>然后我们还要修改这个文件/root/shadowsocks/shadowsocks/config.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;server&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">&quot;server_ipv6&quot;: &quot;[::]&quot;,</span><br><span class="line">&quot;server_port&quot;:8388,</span><br><span class="line">&quot;local_address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">&quot;local_port&quot;:1080,</span><br><span class="line">&quot;password&quot;:&quot;m&quot;,</span><br><span class="line">&quot;timeout&quot;:300,</span><br><span class="line">&quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们来导入数据库。进入MySQL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# mysql -u root -p</span><br><span class="line">mysql&gt; use shadowsocks;</span><br><span class="line">mysql&gt; source /root/shadowsocks/shadowsocks/shadowsocks.sql;</span><br><span class="line">mysql&gt; exit;</span><br></pre></td></tr></table></figure></p>
<p>导入数据库之后，我们在shadowsocks目录下运行一下server.py，具体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd shadowsocks/shadowsocks/</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# python server.py</span><br></pre></td></tr></table></figure></p>
<p>没有error的话，ctrl + c结束进程，我们进行下一步,安装守护进程，这样重启以后或者程序崩了还能自己重启。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install python-pip python-m2crypto supervisor</span><br></pre></td></tr></table></figure></p>
<p>然后我们需要新建两个文件，具体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# vim /etc/supervisor/conf.d/shadowsocks.conf</span><br></pre></td></tr></table></figure></p>
<p>具体内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[program:shadowsocks]</span><br><span class="line">command=python /root/shadowsocks/shadowsocks/server.py -c /root/shadowsocks/shadowsocks/config.json</span><br><span class="line">autorestart=true</span><br><span class="line">user=root</span><br></pre></td></tr></table></figure></p>
<p>再创建一个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# vim /etc/supervisor/conf.d/cgi.conf</span><br></pre></td></tr></table></figure></p>
<p>具体内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[program:cgi]</span><br><span class="line">command=php5-cgi -b localhost:9000</span><br><span class="line">autorestart=true</span><br><span class="line">user=root</span><br></pre></td></tr></table></figure></p>
<p>然后命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd shadowsocks/shadowsocks</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# service supervisor start</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# supervisorctl reload</span><br></pre></td></tr></table></figure></p>
<p>在以下两个文件<code>/etc/profile</code>和<br><code>/etc/default/supervisor</code>结尾添加如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 51200</span><br><span class="line">ulimit -Sn 4096</span><br><span class="line">ulimit -Hn 8192</span><br></pre></td></tr></table></figure></p>
<p>至此ss的后端服务已经搞定了，现在我们来整前端界面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd /usr/share/nginx/</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# wget https://github.com/orvice/ss-panel/archive/v2.zip -O master.zip</span><br></pre></td></tr></table></figure></p>
<p>然后解压master.zip文件，如果没有解压软件，运行命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# apt-get install unzip</span><br></pre></td></tr></table></figure></p>
<p>然后开始解压文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# unzip master.zip</span><br></pre></td></tr></table></figure></p>
<p>然后重命名文件夹,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# mv ss-panel-master ss</span><br></pre></td></tr></table></figure></p>
<p>现在来修改文件夹权限,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd /usr/share/nginx/</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# chmod 777 * -R /usr/share/nginx/html</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# chmod 777 * -R /usr/share/nginx/ss</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# chown -R www-data:www-data /usr/share/nginx/html</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# chown -R www-data:www-data /usr/share/nginx/ss</span><br></pre></td></tr></table></figure></p>
<p>然后我们需要将ss-panel中的数据库导入我们刚刚创建的数据库中，还是进入MySQL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# mysql -u root -p</span><br><span class="line">mysql&gt; use shadowsocks;</span><br><span class="line">mysql&gt; source /usr/share/nginx/ss/sql/invite_code.sql;</span><br><span class="line">mysql&gt; source /usr/share/nginx/ss/sql/ss_admin.sql;</span><br><span class="line">mysql&gt; source /usr/share/nginx/ss/sql/ss_node.sql;</span><br><span class="line">mysql&gt; source /usr/share/nginx/ss/sql/ss_reset_pwd.sql;</span><br><span class="line">mysql&gt; source /usr/share/nginx/ss/sql/user.sql;</span><br><span class="line">mysql&gt; exit;</span><br></pre></td></tr></table></figure></p>
<p>然后我们来修改配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd /usr/share/nginx</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~#  mv /usr/share/nginx/ss/lib/config-simple.php /usr/share/nginx/ss/lib/config.php</span><br></pre></td></tr></table></figure></p>
<p>以下是congfig.php文件的内容我们可以针对自己的需求来修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> * 1 md5</span><br><span class="line"> * 2 带salt的Sha256加密，新安装建议使用此加密方式！</span><br><span class="line"> */</span><br><span class="line">$pwd_mode = 1;</span><br><span class="line"></span><br><span class="line">//用户注册后获得的邀请码最低最高</span><br><span class="line">//都设置为0用户就不能邀请</span><br><span class="line">$user_invite_min = &apos;1&apos;;</span><br><span class="line">$user_invite_max = &apos;1&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">//选择邮件服务</span><br><span class="line">// smtp未完成，现在只能用mailgun</span><br><span class="line">//mail-gun</span><br><span class="line">//mail-smtp</span><br><span class="line">$Selectmailservice = &quot;mail-gun&quot;;</span><br><span class="line">//邮件发件人</span><br><span class="line">$sender = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">//mail-gun</span><br><span class="line">// Get your key from https://mailgun.com</span><br><span class="line">$mailgun_key = &quot;&quot;;</span><br><span class="line">$mailgun_domain = &quot;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">//mail-smtp</span><br><span class="line">// smtp发件方式暂时无法使用</span><br><span class="line">//设置smtp服务器连接方式:  </span><br><span class="line">//加密连接(ssl) = &quot;1&quot;</span><br><span class="line">//普通连接 = &quot;0&quot;</span><br><span class="line">$mail_smtp_Connection = &quot;1&quot;;</span><br><span class="line">//smtp服务器端口 25 , 465 ...</span><br><span class="line">$mail_smtp_Port = 465;</span><br><span class="line">//smtp服务器</span><br><span class="line">$mail_smtp_Server = &quot;smtp.mailgun.org&quot;;</span><br><span class="line">//邮件帐号</span><br><span class="line">$mail_smtp_Account = &quot;&quot;;</span><br><span class="line">//邮件密码</span><br><span class="line">$mail_smtp_password = &quot;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">require_once &apos;do.php&apos;;</span><br></pre></td></tr></table></figure></p>
<p>到此，ss-panel前端界面也安装完毕，然后我们需要修改一下Nginx配置文件，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# cd /etc/nginx/sites-available/</span><br><span class="line">root@ubuntu-512mb-sfo1-01:~# vim default</span><br></pre></td></tr></table></figure></p>
<p>把default文件修改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 443;</span><br><span class="line">server_name localhost;</span><br><span class="line">server_name_in_redirect off;</span><br><span class="line">root /usr/share/nginx/ss;</span><br><span class="line">index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">try_files $uri $uri/ /index.php?q=$uri&amp;$args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">include /etc/nginx/fastcgi_params;</span><br><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME /usr/share/nginx/ss$fastcgi_script_name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-512mb-sfo1-01:~# shutdown -r now</span><br></pre></td></tr></table></figure></p>
<p>然后我们访问<code>http://ip:443</code>就可以看到ss-panel前端界面了：</p>
<p><img src="http://ww1.sinaimg.cn/large/9f1201f5gw1eyydl4hdbuj21kw15edog.jpg" alt=""></p>
<p>后端我们可以<code>http://ip:443/admin</code>界面如下<br><img src="http://ww1.sinaimg.cn/large/9f1201f5gw1eyydlkveq7j20rs0jygmc.jpg" alt=""><br>如果不知道账户名，密码的话，我们可以去数据库查一下，我们可以登录数据库中，看一下<code>shadowsocks</code>库中的表</p>
<p><img src="http://ww1.sinaimg.cn/large/9f1201f5gw1eyydlxnkt2j20jq0akmz7.jpg" alt=""></p>
<p>我们可以查一下<code>ss_user_admin</code>表和<code>user</code>看一下管理员和用户，然后登录后台，进行相应地操作。</p>
<p>到此，ss前后台管理多用户的分享平台就这样建成了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/12/29/写在2015年末/" class="prev">PREV</a><a href="/2015/11/25/casharplayer-percent/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://blog.luobbe.com">luobbe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>