<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 利用runtime动态创建类并且添加属性和方法 · luobbe的随笔</title><meta name="description" content="利用runtime动态创建类并且添加属性和方法 - luobbe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.luobbe.com/atom.xml" title="luobbe的随笔"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/luobbe" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lovels" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">利用runtime动态创建类并且添加属性和方法</h1><div class="post-info">2015年9月22日</div><div class="post-content"><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Objective-C是一门动态语言，它的很多东西都是运行的时候才决定的，比如调用的方法等等。利用这个特性可以做很多事情，可以动态的创建类、添加方法、属性，今天就来通过一个例子练习一下。</p>
<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要使用<code>runtime</code>首先我们要引入头文件<code>#import &lt;objc/runtime.h&gt;</code>然后在<code>- (void)viewDidLoad</code>中动态创建类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//动态创建类</span></span><br><span class="line">Class person = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">"Person"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//添加变量</span></span><br><span class="line">class_addIvar(person, <span class="string">"name"</span>, <span class="keyword">sizeof</span>(<span class="built_in">NSString</span> *), <span class="number">0</span>, <span class="string">"@"</span>);</span><br><span class="line"><span class="comment">//添加函数  sayHi</span></span><br><span class="line">class_addMethod(person, <span class="keyword">@selector</span>(sayHi:), (IMP)sayHi, <span class="string">"v@:"</span>);</span><br><span class="line">objc_registerClassPair(person);</span><br><span class="line"><span class="comment">//初始化一个person对象</span></span><br><span class="line"><span class="keyword">id</span> Tom = [[person alloc] init];</span><br><span class="line">[Tom setValue:<span class="string">@"Tom"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line">[Tom sayHi:<span class="string">@"Jeck"</span>];</span><br></pre></td></tr></table></figure>
<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上述代码，我们通过<code>objc_allocateClassPair()</code>创建了一个继承<code>NSObject</code>的<code>person</code>的子类，然后通过<code>objc_registerClassPair()</code>这个函数注册了<code>person</code>类，下面我们就可以使用这个类了，使用之前我们在给<code>person</code>类中添加一个<code>name</code>属性和<code>sayHi:</code>方法，分别通过<code>class_addIvar()</code>和<code>class_addMethod()</code>来添加，接下来我们要实现我们添加的<code>sayHi:</code>方法，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个函数必须写，要不然xcode会报错，实际运行的时候，这个函数是不会调用的</span></span><br><span class="line">-(<span class="keyword">void</span>)sayHi:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行的时候，会调用这个方法</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> sayHi(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    Ivar n = class_getInstanceVariable([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">id</span> a = object_getIvar(<span class="keyword">self</span>, n);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"hello %@,my name is %@"</span>,name,a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>static void sayHi(id self, SEL _cmd, NSString *name)</code>这个就是我们运行时候调用的方法，其中<code>self</code>使我们使用<code>person</code>创建的对象<code>Tom</code>,<code>_cmd</code>是调用的方法名，<code>name</code>就是传过来的参数，如果有多个参数，可以写成<code>static void sayHi(id self, SEL _cmd, NSString *name,...)</code>省略号可以填写你愿意添加的参数。<a id="more"></a></p>
<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样我们就利用<code>runtime</code>动态的创建了一个<code>person</code>类，包括了<code>name</code>属性和<code>sayHi:</code>方法，运行如结果如下图：</p>
<p><img src="http://ww2.sinaimg.cn/large/9f1201f5gw1exhzj1s1iej20k802qgm0.jpg" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/09/28/scrolllabel/" class="prev">PREV</a><a href="/2015/09/01/ios-pasteboard/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://blog.luobbe.com">luobbe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-72079763-1",'auto');ga('send','pageview');</script></body></html>