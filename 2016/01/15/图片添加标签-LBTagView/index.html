<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 图片添加标签:LBTagView · luobbe的随笔</title><meta name="description" content="图片添加标签:LBTagView - luobbe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.luobbe.com/atom.xml" title="luobbe的随笔"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/luobbe" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lovels" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">图片添加标签:LBTagView</h1><div class="post-info">2016年1月15日</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>前两天写了一个轮子，主要是给图片视图添加标签的，昨天在微博上艾特<a href="http://weibo.com/onevcat" target="_blank" rel="noopener">喵大</a>、<a href="http://weibo.com/u/1438670852" target="_blank" rel="noopener">叶神</a>和<a href="http://weibo.com/luohanchenyilong" target="_blank" rel="noopener">iOS程序犭袁</a>，然后火了一把，首先我感谢各位对这个小小功能的关注，让我受宠若惊。效果主要是这个样子</p>
<p><img src="http://ww3.sinaimg.cn/bmiddle/9f1201f5jw1ezz5g7arztg209g0de4g6.gif" alt="gif"></p>
<p>这两天也有小伙伴私信我能不能简单的讲一下其中的原理，其实用到的知识很简单，今天我就简单地说一下原理和实现。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><hr>
<p>为了方便，我们姑且称这个控件是<code>LBTagView</code>，他的组成主要是一个带有三角形<code>Label</code>、一个小圆点的<code>UIView</code>和<code>CALayer</code>逐渐放大的圆环。三角形的<code>Label</code>是用<code>CAShapeLayer</code>结合<code>UIBezierPath</code>画出来的，大致的原理就是这样的，下面我们来把主要的步骤实现一下。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><hr>
<ul>
<li>三角形的<code>Label</code></li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)triangle:(<span class="built_in">UILabel</span> *)label</span><br><span class="line">&#123;</span><br><span class="line">    [label.layer.sublayers makeObjectsPerformSelector:<span class="keyword">@selector</span>(removeFromSuperlayer)];</span><br><span class="line">    <span class="built_in">CGFloat</span> angleWidth = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">UIBezierPath</span>  * path =  [ <span class="built_in">UIBezierPath</span>  new ];</span><br><span class="line">    [path moveToPoint :( <span class="built_in">CGPoint</span> ) &#123; angleWidth ,  <span class="number">0</span> &#125;];</span><br><span class="line">    [path addLineToPoint :( <span class="built_in">CGPoint</span> ) &#123; <span class="number">0</span>, <span class="built_in">CGRectGetHeight</span>(label.frame)/<span class="number">2.0</span>&#125;];</span><br><span class="line">    [path addLineToPoint :( <span class="built_in">CGPoint</span> ) &#123; angleWidth, <span class="built_in">CGRectGetHeight</span>(label.frame)&#125;];</span><br><span class="line">    [path addLineToPoint :( <span class="built_in">CGPoint</span> ) &#123; <span class="built_in">CGRectGetWidth</span>(label.frame), <span class="built_in">CGRectGetHeight</span>(label.frame)&#125;];</span><br><span class="line">    [path addLineToPoint :( <span class="built_in">CGPoint</span> ) &#123; <span class="built_in">CGRectGetWidth</span>(label.frame), <span class="number">0</span>&#125;];</span><br><span class="line">    [path addLineToPoint :( <span class="built_in">CGPoint</span> ) &#123; angleWidth, <span class="number">0</span>&#125;];</span><br><span class="line">    <span class="built_in">CAShapeLayer</span>* mask = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    mask.path = path.CGPath ;</span><br><span class="line">    label.layer.mask = mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些代码所要达到的效果大概如下，其实显示的主要是<code>CAShapeLayer</code>所在红框部分的内容<a id="more"></a>:</p>
<p><img src="http://ww4.sinaimg.cn/large/9f1201f5gw1f00kbisyqqj20fa09kt8x.jpg" alt=""></p>
<ul>
<li><code>CALayer</code>的动画</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)circleAnimation:(<span class="built_in">CALayer</span> *)layer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CAAnimationGroup</span> *animationGroup = [<span class="built_in">CAAnimationGroup</span> animation];</span><br><span class="line">    animationGroup.repeatCount = HUGE_VALF;</span><br><span class="line">    [animationGroup setDuration:<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">CAMediaTimingFunction</span> *timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseOut];</span><br><span class="line">    animationGroup.timingFunction = timingFunction;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CABasicAnimation</span> *fadeAnimation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"opacity"</span>];</span><br><span class="line">    fadeAnimation.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.5</span>];</span><br><span class="line">    fadeAnimation.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CABasicAnimation</span> *scaleAnimation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"transform.scale"</span>];</span><br><span class="line">    scaleAnimation.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">1</span>];</span><br><span class="line">    scaleAnimation.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">5</span>];</span><br><span class="line">    animationGroup.animations = [<span class="built_in">NSArray</span> arrayWithObjects:fadeAnimation, scaleAnimation, <span class="literal">nil</span>];</span><br><span class="line">    [layer addAnimation:animationGroup forKey:<span class="string">@"fadeAnimation"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些代码主要实现的是<code>CALayer</code>的放大和<code>opacity</code>值的变化，并且是一直重复的。</p>
<ul>
<li><code>LBTagView</code>大小的确定<br>这个环节我设计的是在设置<code>Label</code>的<code>text</code>的时候用系统自带的方法<code>sizeToFit</code>来确定<code>Label</code>的大致大小，然后适当地放大<code>Label</code>的宽高，看起来比较和谐点，然后每次设置<code>text</code>都会把之前的<code>CAShapeLayer</code>删除，在重新创建新的<code>CAShapeLayer</code>，这就解决了<code>LBTagView</code>大小的问题了，也就是说我们只需要指定<code>LBTagView</code>的位置就行了，大小是由<code>Font</code>来控制的。</li>
<li><code>LBTagView</code>移动<br>我们需要使用到<code>UIResponder</code>中的方法:</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">- (<span class="keyword">void</span>)touchesMoved:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br></pre></td></tr></table></figure>
<p>在<code>touchesBegan</code>记录一下开始的触摸点<code>lastPoint</code>，然后在<code>touchesMoved</code>获取到当前移动的点<code>point</code>具体代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UITouch</span> *touch = [touches anyObject];</span><br><span class="line">   <span class="built_in">CGPoint</span> currentPint = [touch locationInView:<span class="keyword">self</span>.superview];</span><br><span class="line">   <span class="keyword">self</span>.center = <span class="built_in">CGPointMake</span>(<span class="keyword">self</span>.center.x + currentPint.x - lastPoint.x, <span class="keyword">self</span>.center.y + currentPint.y - lastPoint.y);</span><br><span class="line">   lastPoint = currentPint;</span><br></pre></td></tr></table></figure>
<p>为了方便的、符合自己需求的使用<code>LBTagView</code>我又在<code>LBTagView.h</code>中添加了可以修改<code>LBTagView</code>样式的属性，如下代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//is can be moved</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> canMove;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//text</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *text;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//default [UIColor whiteColor]</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *textColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//default [UIFont systemFontOfSize:12]</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIFont</span> *font;</span><br><span class="line"></span><br><span class="line"><span class="comment">//default [UIColor colorWithRed:0 green:0 blue:0 alpha:0.5]</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *backgroundColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//default [UIColor colorWithRed:1 green:1 blue:1 alpha:0.8]</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *circlrColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//default [UIColor colorWithRed:0 green:0 blue:0 alpha:0.7]</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *circlrShadowColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//tap action</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UITapGestureRecognizer</span> *tapGestureRecognizer;</span><br></pre></td></tr></table></figure>
<p>也就是说显示层面的都可以自定义，这样就非常方便和灵活了。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><hr>
<p>使用的时候，非常简单，最低只需要三行代码就可以搞定给图片添加标签的功能了：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LBTagView *tag = [[LBTagView alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">50</span>, <span class="number">300</span>, <span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line">tag.text = <span class="string">@"hello world"</span>;</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:tag];</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><hr>
<p>一个简单但是在购物平台或者自拍平台又很主流的功能就这么诞生了，功能很简单，实现也不难。通过这两天看大家在<a href="http://www.weibo.com/luobbe" target="_blank" rel="noopener">微博</a>的转发和<a href="https://github.com/lovels" target="_blank" rel="noopener">Github</a>的star，我非常感谢，希望以后能写出更多好用的代码，与大家一起分享。本文<a href="https://github.com/lovels/LBTagView" target="_blank" rel="noopener">Demo</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/01/03/shadowsocks-sspanel/" class="prev">上一篇</a><a href="/2015/12/29/写在2015年末/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://blog.luobbe.com">luobbe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-72079763-1",'auto');ga('send','pageview');</script></body></html>